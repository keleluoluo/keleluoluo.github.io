<template>
    <view>
      <button @click="toggleCamera">切换摄像头</button>
        <button v-for="(item,index) in dataList" :key="index" @click="videoClick(item)">{{item.count}}</button>
      <video id="videoDom" ref="videoDom" autoplay playsinline></video>
    </view>
  </template>
<script>
    export default {
        data() {
            return {
                currentStream: undefined,
                dataList: [],
                toggle: true
            };
        },
        methods: {
            getdatalist() {
                let _this = this
                console.log('调用成功')
                navigator.mediaDevices.enumerateDevices().then(res => {
                    this.gotDevices(res)
                    _this.dataList.forEach(res => {
                        if (res.count == '1') {
                            _this.videoClick(res)
                        }
                    })
                });
            },
            toggleCamera() {
                this.getdatalist()
                let _this = this
                this.toggle = !this.toggle
                if (this.dataList) {
                    if (this.toggle) {
                        console.log('前置')
                            // 前置
                        _this.dataList.forEach(res => {
                            if (res.count == '1') {
                                _this.videoClick(res)
                            }
                        })
                    } else {
                        console.log('后置')
                        console.log(_this.dataList)
                        _this.videoClick(_this.dataList[_this.dataList.length - 1])
                            // 后置
                    }
                }

            },
            stopMediaTracks(stream) {
                stream.getTracks().forEach(track => {
                    track.stop();
                });
            },
            videoClick(item) {
                let _this = this

                if (item) {
                    if (typeof _this.currentStream !== "undefined") {
                        _this.stopMediaTracks(_this.currentStream);
                    }
                    const videoConstraints = {};
                    console.log('设备')
                    console.log(JSON.stringify(item))
                    console.log(item.deviceId)
                    videoConstraints.deviceId = {
                        exact: item.deviceId
                    };
                    const constraints = {
                        video: videoConstraints,
                        audio: false
                    };
                    console.log(constraints)
                    navigator.mediaDevices
                        .getUserMedia(constraints)
                        .then(stream => {
                            _this.currentStream = stream;
                            window.src = stream
                            document.getElementsByTagName('video')[0].srcObject = window.src
                            return navigator.mediaDevices.enumerateDevices();
                        })
                        .then(res => {
                            _this.gotDevices(res)
                        })
                        .catch(error => {
                            console.log(error + '出错');
                        });
                }

            },
            gotDevices(mediaDevices) {
                let _this = this
                const controls = document.getElementById("controls");
                const video = document.getElementById("videoDom")
                this.dataList = []
                let count = 1;
                mediaDevices.forEach(mediaDevice => {
                    if (mediaDevice.kind === "videoinput") {
                        mediaDevice.count = `${count++}`
                        _this.dataList.push(mediaDevice)
                    }
                });
            },
        }
    };
</script>

<style lang="scss">

</style>